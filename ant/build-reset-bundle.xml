<?xml version="1.0"?>
<!-- 
	Main commands: reset-bundle(default), save, load
-->
<project name="Liferay-Automation-Properties">
	<!--File includes-->
	<property file="app.properties"/>

	<taskdef resource="net/sf/antcontrib/antlib.xml">
		<classpath>
			<pathelement location="${antcontrib.location}/ant-contrib.jar" />
		</classpath>
	</taskdef>

	<!-- Deletes and creates a fresh MYSQL database -->
	<macrodef name="reset-db">
		<attribute name="exePath" />
		<attribute name="databaseName" />

		<sequential>
			<echo>Resetting Database ${sql.databaseName}</echo>

			<exec executable="@{exePath}">
				<arg value="-e"/>
				<arg value="drop database if exists @{databaseName}; create database @{databaseName} char set utf8;"/>
			</exec>

			<echo>Resetting successful!</echo>
		</sequential>
	</macrodef>

	<macrodef name="reset-db-maria">
		<attribute name="exePath" />
		<attribute name="databaseName" />

		<sequential>
			<echo>Resetting Database ${sql.databaseName}</echo>
			<exec executable="@{exePath}">
				<arg value="-e"/>
				<arg value="drop database if exists @{databaseName}; create database @{databaseName} char set utf8;"/>
			</exec>

			<echo>Resetting successful!</echo>
		</sequential>
	</macrodef>

	<!-- Searches for and updates portal-ext.properties-->
	<macrodef name="create-portal-ext-prop">
		<attribute name="propertyDir" />
		<attribute name="serverDir" />

		<sequential>
			<echo>Searching for portal-ext.properties</echo>
			<if>
				<available file="@{propertyDir}/portal-ext.properties"/>
				<then>
					<echo>portal-ext.properties found!</echo>
					<if>
						<available file="@{serverDir}/webapps/ROOT/WEB-INF/classes/" type="dir"/>
						<then>
							<echo>Bundle folder found! copying to @{serverDir}/webapps/ROOT/WEB-INF/classes/</echo>
							<delete file="@{serverDir}/webapps/ROOT/WEB-INF/classes/portal-ext.properties"></delete>
							<copy file="@{propertyDir}/portal-ext.properties" todir="@{serverDir}/webapps/ROOT/WEB-INF/classes/"></copy>
						</then>
					</if>
				</then>
				<else>
					<echo>portal-ext.properties not found!</echo>
					<fail message="Missing portal-ext.properties at @{propertyDir}"/>
				</else>
			</if>
		</sequential>
	</macrodef>

	<!-- Searches for and updates portal-ext.properties-->
	<macrodef name="create-portal-ext-prop-mariadb">
		<attribute name="propertyDir" />
		<attribute name="serverDir" />

		<sequential>
			<echo>Searching for portal-ext.properties</echo>
			<if>
				<available file="@{propertyDir}/maria/portal-ext.properties"/>
				<then>
					<echo>portal-ext.properties found!</echo>
					<if>
						<available file="@{serverDir}/webapps/ROOT/WEB-INF/classes/" type="dir"/>
						<then>
							<echo>Bundle folder found! copying to @{serverDir}/webapps/ROOT/WEB-INF/classes/</echo>
							<delete file="@{serverDir}/webapps/ROOT/WEB-INF/classes/portal-ext.properties"></delete>
							<copy file="@{propertyDir}/maria/portal-ext.properties" todir="@{serverDir}/webapps/ROOT/WEB-INF/classes/"></copy>
						</then>
					</if>
				</then>
				<else>
					<echo>portal-ext.properties not found!</echo>
					<fail message="Missing portal-ext.properties at @{propertyDir}/maria"/>
				</else>
			</if>
		</sequential>
	</macrodef>

	<!-- Deletes Data and Deploy Folders -->
	<macrodef name="reset-data-deploy">
		<attribute name="homeDir" />

		<sequential>
			<echo>Searching for data folder</echo>
			<if>
				<available file="@{homeDir}/data" type="dir"/>
				<then>
					<echo>Found! Deleting data folder</echo>
					<delete dir="@{homeDir}/data"/>
				</then>
				<else>
					<echo>Data folder already clean!</echo>
				</else>
			</if>

			<echo>Searching for deploy folder</echo>
			<if>
				<available file="@{homeDir}/deploy" type="dir"/>
				<then>
					<echo>Found! Deleting deploy folder</echo>
					<!--<delete dir="@{homeDir}/deploy"/>-->
				</then>
				<else>
					<echo>Deploy folder already clean!</echo>
				</else>
			</if>

			<echo>Finished deleting folders</echo>
		</sequential>
	</macrodef>

	<macrodef name="replace-mysql-jar">
		<attribute name="serverDir" />
		<attribute name="jarPath" />

		<sequential>
			<echo>Updating mysql.jar in @{serverDir}/lib/ext</echo>
			<if>
				<available file="@{serverDir}/lib/ext/mysql.jar"/>
				<then>
					<echo>Old mysql.jar Found! Deleting.</echo>
					<delete file="@{serverDir}/lib/ext/mysql.jar"/>
				</then>
			</if>
			<copy file="@{jarpath}/mysql.jar" todir="@{serverDir}/lib/ext"/>
		</sequential>
	</macrodef>

	<macrodef name="remove-chat-jar">
		<attribute name="serverDir" />

		<sequential>
			<echo>Deleting chat jars in @{serverDir}/osgi/modules</echo>

			<if>
				<available file="@{serverDir}/osgi/modules/com.liferay.chat.api.jar"/>
				<then>
					<echo>com.liferay.chat.api.jar Found! Deleting.</echo>
					<delete file="@{serverDir}/osgi/modules/com.liferay.chat.api.jar"/>
				</then>
			</if>

			<if>
				<available file="@{serverDir}/osgi/modules/com.liferay.chat.service.jar"/>
				<then>
					<echo>com.liferay.chat.service.jar Found! Deleting.</echo>
					<delete file="@{serverDir}/osgi/modules/com.liferay.chat.service.jar"/>
				</then>
			</if>

			<if>
				<available file="@{serverDir}/osgi/modules/com.liferay.chat.web.jar"/>
				<then>
					<echo>com.liferay.chat.web.jar Found! Deleting.</echo>
					<delete file="@{serverDir}/osgi/modules/com.liferay.chat.web.jar"/>
				</then>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="add-license">
		<attribute name="homeDir" />
		<attribute name="licenseLocation" />

		<sequential>
			<echo>Checking if License is needed</echo>
			<if>
				<available file="@{licenseLocation}/7.0License.xml"/>
				<then>
					<echo>License found!</echo>
					<copy file="@{licenseLocation}/7.0License.xml" todir="@{homeDir}/deploy/"></copy>
				</then>
				<else>
					<echo>License not found!</echo>
					<fail message="Missing License at @{licenseLocation}/7.0License.xml"/>
				</else>
			</if>
		</sequential>
	</macrodef>

	<macrodef name="setup-setenv">
		<attribute name="appServerMemory" />
		<attribute name="serverDir" />

		<sequential>
			<echo>Setting memory of @{serverDir}/bin/setenv.bat to use 4GB</echo>
			<replaceregexp file="@{serverDir}/bin/setenv.bat"
			match="-Xms[0-9]+m" replace="-Xms@{appServerMemory}" byline="false" />
			<replaceregexp file="@{serverDir}/bin/setenv.bat"
			match="-Xmx[0-9]+m" replace="-Xmx@{appServerMemory}" byline="false" />
		</sequential>
	</macrodef>
</project>